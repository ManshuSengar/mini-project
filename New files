import React, { useState, useEffect } from 'react';
import { Formik, Form, Field } from 'formik';
import * as Yup from 'yup';
import { editUser, addUser, getUsersById, deleteUser } from '../../../features/common/commonApi';
import {
  TextField,
  Checkbox,
  FormControlLabel,
  Button,
  Grid,
  Typography,
  Box,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Select,
  MenuItem,
  InputLabel,
  FormControl,
  Card,
  Link,
  Tooltip,
  Divider,
  Radio,
  RadioGroup
} from '@mui/material';
import { DataGrid } from '@mui/x-data-grid';
import EditIcon from '@mui/icons-material/Edit';
import DeleteIcon from '@mui/icons-material/Delete';
import { getUsersLists, getFetchNBFCPartners } from 'features/common/commonApi';
import { toast } from 'react-toastify';

const validationSchema = Yup.object().shape({
  userName: Yup.string().required('Username is required'),
  email: Yup.string().email('Invalid email').required('Email is required'),
  mobileNo: Yup.string()
    .matches(/^[0-9]{10}$/, 'Mobile number must be 10 digits')
    .required('Mobile number is required'),
  address: Yup.string().required('Address is required'),
  city: Yup.string().required('City is required'),
  regType: Yup.string().required('User Type is required'),
  district: Yup.string().required('District is required'),
  state: Yup.string().required('State is required'),
  pincode: Yup.string()
    .matches(/^[0-9]{6}$/, 'Pincode must be 6 digits')
    .required('Pincode is required'),
  nbfcName: Yup.string().required('NBFC Name is required'),
  portalRoles: Yup.array().min(1, 'At least one portal role must be selected')
});

const initialValues = {
  userName: '',
  email: '',
  mobileNo: '',
  address: '',
  city: '',
  district: '',
  state: '',
  pincode: '',
  nbfcName: '',
  portalRoles: [],
  regType: ''
};

const UserForm = () => {
  const [users, setUsers] = useState([]);
  const [nbfcs, setNbfcs] = useState([]);
  const [openDialog, setOpenDialog] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false);
  const [userToDelete, setUserToDelete] = useState(null);

  const getNbfcName = async () => {
    try {
      const response = await getFetchNBFCPartners();
      setNbfcs(response?.data);
    } catch (err) {
      toast.error('Something went wrong while fetching Nbfc');
    }
  };

  const getUsersList = async () => {
    try {
      const response = await getUsersLists();
      setUsers(response?.data);
    } catch (err) {
      toast.error('Something went wrong.');
    }
  };

  useEffect(() => {
    getUsersList();
    getNbfcName();
  }, []);

  const handleSubmit = async (values, { setSubmitting, resetForm }) => {
    setSubmitting(false);
    try {
      const updatedValues = {
        userMobileNo: values.mobileNo,
        nbfcChannelPartnerCode: values.nbfcName,
        regType: values.regType,
        emailId: values.email,
        userName: values.userName,
        roles: values?.portalRoles?.join(','),
        addressDto: {
          address: values.address,
          city: values.city,
          district: values.district,
          addState: values.state,
          pinCode: values.pincode
        }
      };

      if (editingUser) {
        await editUser({ ...updatedValues, userId: values.userId });
        toast.success('User updated successfully.');
      } else {
        await addUser({ ...updatedValues, userType: 'NBFC' });
        toast.success('User added successfully.');
      }
      await new Promise((resolve) => setTimeout(resolve, 2000));
      getUsersList();
      resetForm();
      setOpenDialog(false);
      setEditingUser(null);
    } catch (error) {
      toast.error('Something went wrong.');
    }
  };

  const handleEdit = async (userDetail) => {
    try {
      const result = await getUsersById(userDetail.userId);
      if (result.statusCode == 200) {
        const user = result.data;
        const userData = {
          userId: user?.userId,
          userType: user?.userType,
          mobileNo: user.userMobileNo,
          nbfcName: user.nbfcChannelPartnerCode,
          regType: user.regType,
          email: user.emailId,
          userName: user.userName,
          address: user?.addressDto?.address,
          city: user?.addressDto?.city,
          district: user?.addressDto?.district,
          state: user?.addressDto?.addState,
          pincode: user?.addressDto?.pinCode,
          addressTypeId: user?.addressDto?.addressTypeId,
          addressType: user?.addressDto?.addressType,
          portalRoles: user?.roles?.split(',') || []
        };

        setEditingUser(userData);
        setOpenDialog(true);
      } else {
        toast.error('Something went wrong.');
      }
    } catch (err) {
      toast.error('Something went wrong.');
    }
  };

  const handleDelete = (userDetail) => {
    setUserToDelete(userDetail);
    setDeleteConfirmOpen(true);
  };

  const handleConfirmedDelete = async () => {
    try {
      const result = await deleteUser(userToDelete.userId);
      if (result.statusCode == 200) {
        toast.success('User deleted successfully.');
        getUsersList();
      } else {
        toast.error('Something went wrong.');
      }
    } catch (err) {
      toast.error('Something went wrong.');
    } finally {
      setDeleteConfirmOpen(false);
      setUserToDelete(null);
    }
  };

  const filteredUsers = users?.filter(
    (user) =>
      user?.userName?.toLowerCase().includes(searchTerm?.toLowerCase()) ||
      user?.nbfcChannelPartnerCode?.toLowerCase().includes(searchTerm?.toLowerCase()) ||
      user?.emailId?.toLowerCase().includes(searchTerm?.toLowerCase())
  );

  const columns = [
    { field: 'userName', headerName: 'User Name', width: 130 },
    { field: 'nbfcPartnerName', headerName: 'NBFC Name', width: 250 },
    { field: 'emailId', headerName: 'Email Id', width: 180 },
    { field: 'userMobileNo', headerName: 'Mobile No', width: 150 },
    { field: 'roles', headerName: 'Portal Roles', width: 250 },
    {
      field: 'actions',
      headerName: 'Actions',
      width: 120,
      renderCell: (params) => (
        <>
          <Tooltip title="Edit">
            <Link onClick={() => handleEdit(params.row)} sx={{ marginRight: 2 }}>
              <EditIcon className="colorRed icon-size" />
            </Link>
          </Tooltip>
          <Tooltip title="Delete">
            <Link onClick={() => handleDelete(params.row)}>
              <DeleteIcon className="colorRed icon-size" style={{ color: 'red' }}/>
            </Link>
          </Tooltip>
        </>
      )
    }
  ];

  return (
    <Box className="wrap-admin-table">
      <Card className="wrap-top-head">
        <Box display="flex" justifyContent="space-between" alignItems="center">
          <div className="custome-form wrap-text">
            <TextField
              label="Search by Username or NBFC Name"
              variant="outlined"
              value={searchTerm}
              size="small"
              onChange={(e) => setSearchTerm(e.target.value)}
              fullWidth
            />
          </div>
          <Button
            variant="contained"
            size="small"
            className="add-button"
            onClick={() => {
              setOpenDialog(true);
              setEditingUser('');
            }}
          >
            Add User
          </Button>
        </Box>
      </Card>
      <Card className="wrap-table-body">
        <Box height={400}>
          <DataGrid
            rows={filteredUsers}
            className="custom-grid-table not-show-header-option on-row-selection"
            columns={columns}
            pageSize={5}
            rowsPerPageOptions={[5]}
            getRowId={(row) => row.userName + row.emailId}
          />
        </Box>
      </Card>

      <Dialog open={openDialog} onClose={() => setOpenDialog(false)}>
        <DialogTitle>{editingUser ? 'Edit User' : 'Add User'}</DialogTitle>
        <Formik
          validationSchema={validationSchema}
          enableReinitialize={true}
          initialValues={editingUser || initialValues}
          onSubmit={handleSubmit}
        >
          {({ errors, touched, values, handleChange }) => (
            <>
              <DialogContent>
                <Form className="custome-form mt-13">
                  <Grid container spacing={2}>
                    {/* Form fields... */}
                    {/* (Keeping the existing form fields as they are) */}
                  </Grid>

                  <DialogActions>
                    <Button
                      size="small"
                      onClick={() => {
                        setOpenDialog(false);
                        setEditingUser(null);
                      }}
                    >
                      Cancel
                    </Button>
                    <Button size="small" className="add-button" type="submit" variant="contained" color="primary">
                      {editingUser ? 'Update' : 'Submit'}
                    </Button>
                  </DialogActions>
                </Form>
              </DialogContent>
            </>
          )}
        </Formik>
      </Dialog>

      {/* Delete Confirmation Dialog */}
      <Dialog
        open={deleteConfirmOpen}
        onClose={() => setDeleteConfirmOpen(false)}
      >
        <DialogTitle>Confirm Deletion</DialogTitle>
        <DialogContent>
          Are you sure you want to delete this user?
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setDeleteConfirmOpen(false)}>Cancel</Button>
          <Button onClick={handleConfirmedDelete} color="error">Delete</Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
};

export default UserForm;
