import { Accordion, AccordionDetails, AccordionSummary, Divider, FormControl, Grid, InputLabel, MenuItem, Select, Table, TableBody, TableCell, TableHead, TableRow, TextField, Button } from "@mui/material"
import ExpandMoreIcon from '@mui/icons-material/ExpandMore';
import React, { SyntheticEvent, useCallback, useEffect, useRef, useState } from "react";
import { useAddExecutiveSummaryMutation, useGetExecutiveSummaryByIdQuery } from "../../../features/appraisal/executiveSummaryApi";
import { Formik, Form, useFormikContext } from "formik";
import { styled } from "@mui/material/styles";
import { TextAreaField } from "../../../components/framework/TextAreaAuto";
import { DropDownField } from "../../../components/framework/DropDownField";

import { TextBoxField } from "../../../components/framework/TextBoxField"
import { debounce } from 'lodash';
const AutoSave = ({ debounceMs = 1000 }) => {
  const formik = useFormikContext();
  const [lastSaved, setLastSaved] = useState<any>(null);
 
  const debouncedSubmit = useCallback(
    debounce(async () => {
      try {
        await formik.submitForm();
        setLastSaved(new Date());
      } catch (error) {
        console.error('Error during autosave:', error);
      }
    }, debounceMs),
    [formik.submitForm]
  );
 
  const handleFieldChange = (event: any) => {
    formik.handleChange(event);
    debouncedSubmit();
  };
 
  useEffect(() => {
    return () => {
      debouncedSubmit.cancel();
    };
  }, [debouncedSubmit]);
 
  return { handleFieldChange, lastSaved };
};


const ExecutiveSummery = () => {
  const [expanded, setExpanded] = React.useState('');
  const textRef2 = useRef<any>();
  const textRef1 = useRef<any>();
  const textRef3 = useRef<any>();
  const textRef4 = useRef<any>();
  const textRef5 = useRef<any>();
  const textRef6 = useRef<any>();
  const onOpenChange = (panel: any) => (event: React.SyntheticEvent, isExpanded: any) => {
    setExpanded(isExpanded ? panel : false);
  };
  const formValuesRef = useRef({});

  const [addExecutiveSummary, response] = useAddExecutiveSummaryMutation();
  const [errorMessage, setErrorMessage] = useState<any>("");

  const [id, setId] = useState<number>(12345);
  const { data: executiveData, isLoading, isFetching } = useGetExecutiveSummaryByIdQuery(id);

  const initialValues = {
    nbfcName: '',
    pastAssociation: '',
    briefBackground: '',
    promotor: '',
    extRating: '',
    ramRatingGrade: '',
    internalScore: '',
    productOffered: '',
  };

  const onChangeHandler = function (e: SyntheticEvent, refName: any) {
    const target = e.target as HTMLTextAreaElement;
    refName.current.style.height = "60px";
    refName.current.style.height = `${target.scrollHeight}px`;
  };
  const handleSubmit = async (values: any) => {
    try {
      console.log("hello1");
      await addExecutiveSummary(values).unwrap();
    } catch (err) {
      console.error("Error saving data:", err);
    }
  };

  /// autosave ---> 

 
  /// autosave end ---> 





  if (isLoading) return <h6>Loading... </h6>

  return (
    <>
      <div className='custome-form'>
        <div className='custome-form'>
          <div className='custome-form'>
            <Formik
              initialValues={initialValues}
              onSubmit={handleSubmit}
              enableReinitialize={true}
            >
              {({ values, setFieldValue, handleChange }) => {
                const { handleFieldChange, lastSaved } = AutoSave({ debounceMs: 1000 });
                return (
                  <Form>
                   
                    <Grid spacing={2} padding={4} container className='form-grid'>
                      <Grid item xs={12} sm={6} md={6} lg={6}>
                        <TextBoxField
                          label="Name of the NBFC"
                          name="nbfcName"
                        />
                      </Grid>
                      <Grid item xs={12} sm={6} md={6} lg={6}>
                        <FormControl fullWidth>
                          <InputLabel className="select-label" id="eligibility">Past association with SIDBI</InputLabel>
                          <Select
                            labelId="eligibility"
                            id="pastAssociate"
                            label="Past association with SIDBI"
                            size="small"
                            value={values?.pastAssociation}
                            name="pastAssociation"
                            onChange={handleChange}
                          >
                            <MenuItem value="New to Business">New to Business</MenuItem>
                            <MenuItem value="Existing to Business">Existing to Business</MenuItem>
                            <MenuItem value="Past to Business">New to Business</MenuItem>
                          </Select>
                        </FormControl>
                      </Grid>

                      <Grid item xs={12} sm={12} md={12} lg={12}>
                        <TextAreaField
                          label="Brief background of NBFC/NBFC-MFI"
                          name="briefBackground"
                        />
                      </Grid>
                      <Grid item xs={12} sm={6} md={6} lg={6}>
                        <TextAreaField label="Promoter" name="promotor" />
                      </Grid>
                      <Grid item xs={12} sm={6} md={6} lg={6}>
                        <TextAreaField label="External rating detail" name="extRating" />
                      </Grid>
                      <Grid item xs={12} sm={12} md={12} lg={12}>
                        <Divider className='my-1' textAlign="left">
                          <b>Internal Rating Details </b>
                        </Divider>
                      </Grid>
                      <Grid item xs={12} sm={6} md={6} lg={6}>
                        <TextBoxField
                          label="Internal Score"
                          name="internalRatingScore"
                        />
                      </Grid>
                      <Grid item xs={12} sm={6} md={6} lg={6}>
                        <TextBoxField
                          label="RAM Rating Grade"
                          name="ramRatingGrade"
                        />
                      </Grid>
                      <Grid item xs={12} sm={12} md={12} lg={12}>
                        <Divider className='my-1' textAlign="left">
                          <b>Product offered</b>
                        </Divider>
                      </Grid>
                      <Grid item xs={12} sm={12} md={12} lg={12}>
                        <TextAreaField
                          label="Product offered"
                          name="productOffered"
                        />
                      </Grid>
                      <Grid item xs={12} textAlign="right">
                        {lastSaved && (
                          <p>Last autosaved: {lastSaved.toLocaleTimeString()}</p>
                        )}
                        <Button type="submit" size="small"
                          className="text-capitalize" variant="contained" color="primary">
                          Save
                        </Button>
                      </Grid>
                    </Grid>
                  </Form>
                );
              }}
            </Formik>
          </div>
        </div>
        <Accordion className='custome-accordian mt-3'
          expanded={expanded === 'panel1'} onChange={onOpenChange('panel1')}>
          <AccordionSummary
            expandIcon={<ExpandMoreIcon />}
            aria-controls="panel1-content"
            id="panel1-header"
          >
            Summary of Financial Performance â€“  (` crore)
          </AccordionSummary>
          <AccordionDetails>
            <Grid
              spacing={1}
              padding={2}
              container
              className='form-grid'
            >
              <Grid item xs={12} sm={6} md={6} lg={6}>
                <div className="wrap-inner-table m-0">
                  <Table aria-label="simple table">
                    <TableHead>
                      <TableRow>
                        <TableCell sx={{ width: 40 }}><b>Particulars (Rs Cr)</b></TableCell>
                        <TableCell sx={{ width: 20 }}><b>Latest Fiscal</b></TableCell>
                        <TableCell sx={{ width: 20 }}><b>Latest quarter</b></TableCell>
                      </TableRow>
                    </TableHead>
                    <TableBody>
                      <TableRow>
                        <TableCell>
                          AUM
                        </TableCell>
                        <TableCell>
                          {/* <FormControl fullWidth>
                            <TextField size="small" placeholder="Latest Fiscal" type="text" />
                          </FormControl> */}
                          9,047
                        </TableCell>
                        <TableCell>
                          {/* <FormControl fullWidth>
                            <TextField size="small" placeholder="Latest quarter" type="text" />
                          </FormControl> */}
                          9,047
                        </TableCell>
                      </TableRow>
                      <TableRow>
                        <TableCell>
                          NOF
                        </TableCell>
                        <TableCell>
                          {/* <FormControl fullWidth>
                            <TextField size="small" placeholder="Latest Fiscal" type="text" />
                          </FormControl> */}
                          9,047
                        </TableCell>
                        <TableCell>
                          {/* <FormControl fullWidth>
                            <TextField size="small" placeholder="Latest quarter" type="text" />
                          </FormControl> */}
                          9,047
                        </TableCell>
                      </TableRow>
                      <TableRow>
                        <TableCell>
                          CRAR
                        </TableCell>
                        <TableCell>
                          {/* <FormControl fullWidth>
                            <TextField size="small" placeholder="Latest Fiscal" type="text" />
                          </FormControl> */}
                          9,047
                        </TableCell>
                        <TableCell>
                          {/* <FormControl fullWidth>
                            <TextField size="small" placeholder="Latest quarter" type="text" />
                          </FormControl> */}
                          9,047
                        </TableCell>
                      </TableRow>
                      <TableRow>
                        <TableCell>
                          Tier I
                        </TableCell>
                        <TableCell>
                          {/* <FormControl fullWidth>
                            <TextField size="small" placeholder="Latest Fiscal" type="text" />
                          </FormControl> */}
                          9,047
                        </TableCell>
                        <TableCell>
                          {/* <FormControl fullWidth>
                            <TextField size="small" placeholder="Latest quarter" type="text" />
                          </FormControl> */}
                          9,047
                        </TableCell>
                      </TableRow>
                    </TableBody>
                  </Table>
                </div>
              </Grid>
              <Grid item xs={12} sm={6} md={6} lg={6}>
                <div className="wrap-inner-table m-0">
                  <Table aria-label="simple table">
                    <TableHead>
                      <TableRow>
                        <TableCell sx={{ width: 40 }}><b>Particulars (Rs Cr)</b></TableCell>
                        <TableCell sx={{ width: 50 }}><b>Latest Fiscal</b></TableCell>
                        <TableCell sx={{ width: 50 }}><b>Latest quarter</b></TableCell>
                      </TableRow>
                    </TableHead>
                    <TableBody>
                      <TableRow>
                        <TableCell>
                          Leverage
                        </TableCell>
                        <TableCell>
                          {/* <FormControl fullWidth>
                            <TextField size="small" placeholder="Latest Fiscal" type="text" />
                          </FormControl> */}
                          9,047
                        </TableCell>
                        <TableCell>
                          9,047
                          {/* <FormControl fullWidth>
                            <TextField size="small" placeholder="Latest quarter" type="text" />
                          </FormControl> */}
                        </TableCell>
                      </TableRow>
                      <TableRow>
                        <TableCell>
                          GNPA (%) (Gross Stage 3)
                        </TableCell>
                        <TableCell>
                          {/* <FormControl fullWidth>
                            <TextField size="small" placeholder="Latest Fiscal" type="text" />
                          </FormControl> */}
                          9,047
                        </TableCell>
                        <TableCell>
                          {/* <FormControl fullWidth>
                            <TextField size="small" placeholder="Latest Quarte" type="text" />
                          </FormControl> */}
                          9,047
                        </TableCell>
                      </TableRow>
                      <TableRow>
                        <TableCell>
                          NNPA (%)
                        </TableCell>
                        <TableCell>
                          {/* <FormControl fullWidth>
                            <TextField size="small" placeholder="Latest Fiscal" type="text" />
                          </FormControl> */}
                          9,047
                        </TableCell>
                        <TableCell>
                          {/* <FormControl fullWidth>
                            <TextField size="small" placeholder="Latest Quarte" type="text" />
                          </FormControl> */}
                          9,047
                        </TableCell>
                      </TableRow>
                    </TableBody>
                  </Table>
                </div>
              </Grid>
            </Grid>
            {/* <Grid
              spacing={2}
              padding={4}
              container
              className='form-grid'
            >
              <Grid item xs={12} sm={6} md={6} lg={6}>
                <FormControl fullWidth>
                  <TextField label="Internal rating details" size="small" />
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={6} md={6} lg={6}>
                <FormControl fullWidth>
                  <TextField label="Proposal for sanction of term loan of(Rs Cr.)" size="small" />
                </FormControl>
              </Grid>
            </Grid> */}
          </AccordionDetails>
        </Accordion>

        <Accordion className='custome-accordian'
          expanded={expanded === 'panel2'} onChange={onOpenChange('panel2')}>
          <AccordionSummary
            expandIcon={<ExpandMoreIcon />}
            aria-controls="panel2-content"
            id="panel2-header"
          >
            Facility Details
          </AccordionSummary>
          <AccordionDetails>
            <Grid
              spacing={2}
              padding={4}
              container
              className='form-grid'
            >
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="Amount of loan proposed" size="small" type="text" />
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={8} md={8} lg={8}>
                <FormControl fullWidth>
                  <textarea
                    placeholder="Comment"
                    ref={textRef6}
                    className="text-area-box"
                    onChange={(event: any) => onChangeHandler(event, textRef6)}
                  />
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="Scheme" size="small" type="text" />
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="Total Exposure" size="small" type="text" />
                </FormControl>
              </Grid>
              {/* <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="Validity of drawl" size="small" type="text" />
                </FormControl>
              </Grid> */}
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="Tenure" size="small" type="text" />
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="Moratorium" size="small" type="text" />
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="Repayment frequency" size="small" type="text" />
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="Repayment frequency" size="small" type="text" />
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <InputLabel className="select-label" id="eligibility">Interest rate Type</InputLabel>
                  <Select
                    labelId="eligibility"
                    id="eligibility"
                    size="small"
                    value=""
                    name="eligibility"
                  >
                    <MenuItem value="Fixed">Fixed</MenuItem>
                    <MenuItem value="Floating">Floating</MenuItem>
                  </Select>
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <InputLabel className="select-label" id="eligibility">Benchmark</InputLabel>
                  <Select
                    labelId="eligibility"
                    id="eligibility"
                    size="small"
                    value=""
                    name="eligibility"
                  >
                    <MenuItem value="1 Year MCLR">1 Year MCLR</MenuItem>
                    <MenuItem value="PLR">PLR</MenuItem>
                    <MenuItem value="Repo">Repo</MenuItem>
                  </Select>
                  <span className="water-mark">Benchmark rate (7.5 %)</span>
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="Spread" size="small" type="text" />
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="Interest rate" size="small" type="text" />
                </FormControl>
              </Grid>
              {/* <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="Interest reset" size="small" type="text" />
                </FormControl>
              </Grid> */}
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="Security" size="small" type="text" />
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="ACR" size="small" type="text" />
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="Any PG/ CG/ FD" size="small" type="text" />
                </FormControl>
              </Grid>
              {/* <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <TextField label="Assets to be refinanced" size="small" type="text" />
                </FormControl>
              </Grid> */}
              <Grid item xs={12} sm={12} md={12} lg={12}>
                <FormControl fullWidth>
                  <textarea
                    placeholder="Remarks"
                    ref={textRef3}
                    className="text-area-box"
                    onChange={(event: any) => onChangeHandler(event, textRef3)}
                  />
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={4} md={4} lg={4}>
                <FormControl fullWidth>
                  <FormControl fullWidth>
                    <InputLabel className="select-label" id="eligibility">Delegation of Power-IFCC-DMD</InputLabel>
                    <Select
                      labelId="eligibility"
                      id="eligibility"
                      size="small"
                      value=""
                      name="eligibility"
                    >
                      <MenuItem value="CCIC-CGM">CCIC-CGM</MenuItem>
                      <MenuItem value="IFCC-DMD">IFCC-DMD</MenuItem>
                      <MenuItem value="EC">EC</MenuItem>
                    </Select>
                  </FormControl>
                </FormControl>
              </Grid>
            </Grid>
          </AccordionDetails>
        </Accordion>
      </div>
    </>
  )
}
export default ExecutiveSummery;
